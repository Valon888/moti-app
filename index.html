<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Moti – App</title>
  <!-- 'meta[name=theme-color]' is not supported by Firefox, Firefox for Android, Opera -->
  <!-- Ikona për Home Screen (iOS/Android/Samsung) -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png" />
  <meta name="msapplication-TileColor" content="#0ea5e9" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Moti – App" />
  <!-- 'theme-color' is used by Chrome, Edge, and some Android browsers; not supported by Firefox/Opera -->
  <!-- 'theme-color' is used by Chrome, Edge, and some Android browsers; not supported by Firefox/Opera -->
  <!-- 'theme-color' is used by Chrome, Edge, and some Android browsers; not supported by Firefox/Opera -->
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="application-name" content="Moti – App" />
  <meta name="description" content="Parashikimi i motit për Kosovë. Shtoje në Home Screen për përdorim si aplikacion në Android/iOS/Samsung." />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Moti – App" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css">
    <style>
      /* Mobile map improvements */
      #map.satellite-map {
        width: 100vw;
        max-width: 100vw;
        min-width: 0;
        height: 320px;
        max-height: 50vh;
        border-radius: 18px;
        margin: 0 auto 1em auto;
        box-shadow: 0 2px 16px #0002;
        touch-action: pan-x pan-y;
        /* Remove outline on tap */
        outline: none;
      }
      @media (max-width: 600px) {
        #map.satellite-map {
          height: 45vw;
          min-height: 220px;
          max-height: 60vw;
          border-radius: 14px;
        }
        .app {
          padding: 0.5em;
        }
      }
      /* Make map controls bigger for touch */
      .leaflet-control-zoom a {
        font-size: 1.5em;
        width: 2.2em;
        height: 2.2em;
      }
      .leaflet-control {
        border-radius: 10px !important;
      }
  </style>
  <!-- Push Notification Setup moved to script below -->
  <script>
  // ========== Push Notification Setup ==========
  // Request notification permission on load if not denied
  document.addEventListener("DOMContentLoaded", function() {
    if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
      Notification.requestPermission();
    }
    // Nuk shfaqet më asnjë paralajmërim nëse njoftimet janë të bllokuara
  });
  </script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="app" role="application" aria-label="Aplikacioni i motit">
    <h1>🌤️ Parashikimi i Motit</h1>

    <div class="row" role="search">
      <select id="countrySelect" title="Zgjedh shtetin">
        <option value="KS">Kosovë</option>
        <option value="DE">Gjermani</option>
      </select>
      <select id="langSelect" title="Zgjedh gjuhën">
        <option value="sq">Shqip</option>
        <option value="en">English</option>
        <option value="de">Deutsch</option>
      </select>
      <input id="q" type="search" placeholder="Kërko qytet…" autocomplete="off" list="cityListData" />
      <datalist id="cityListData"></datalist>
      <button id="btnSearch" type="button" title="Kërko">Kërko</button>
      <button id="btnGeo" type="button" title="Përdor lokacionin tim">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" style="vertical-align:middle;"><path fill="#fff" d="M12 2a1 1 0 0 1 1 1v1.07A8.001 8.001 0 0 1 19.93 11H21a1 1 0 1 1 0 2h-1.07A8.001 8.001 0 0 1 13 19.93V21a1 1 0 1 1-2 0v-1.07A8.001 8.001 0 0 1 4.07 13H3a1 1 0 1 1 0-2h1.07A8.001 8.001 0 0 1 11 4.07V3a1 1 0 0 1 1-1Zm0 4a6 6 0 1 0 0 12A6 6 0 0 0 12 6Zm0 2a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z"/></svg>
        GPS
      </button>
    </div>

    <div class="city-list-wrap">
      <div class="city-list-title">Qytetet e Kosovës:</div>
      <div class="city-list" id="cityList"></div>
      <div id="status" class="status"></div>
    </div>


    <section id="current" class="card current" aria-live="polite"></section>


    <section class="card">
      <div class="muted forecast-title">Pamje satelitore interaktive (Esri + OSM)</div>
      <div style="display:flex;align-items:center;gap:1em;">
        <button id="radarToggle" type="button" style="margin-bottom:8px;">Shfaq Radar</button>
        <span id="radarStatus" class="muted" style="font-size:0.95em;"></span>
      </div>
      <div id="map" class="satellite-map"></div>
      <div class="satellite-caption">Burimi: Esri World Imagery &amp; OpenStreetMap, RainViewer Radar</div>
    </section>

    <section class="card">
      <div class="muted forecast-title">Radar Live (Windy.com)</div>
      <div style="display:flex;justify-content:center;align-items:center;">
        <iframe width="100%" height="420" style="max-width:540px;border-radius:18px;border:none;box-shadow:0 2px 16px #0ea5e922;"
          src="https://embed.windy.com/embed2.html?lat=42.6&lon=21.1&detailLat=42.6&detailLon=21.1&width=650&height=420&zoom=7&level=surface&overlay=radar&product=radar&menu=&message=true&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1" title="Radar Live Windy" allowfullscreen></iframe>
      </div>
      <div class="satellite-caption">Burimi: <a href="https://www.windy.com/?radar,42.6,21.1,7" target="_blank" rel="noopener" style="color:#0ea5e9;">Windy.com Radar Live</a></div>
    </section>

    <section class="card">
      <div class="muted forecast-title">Radar Live (Gjermani)</div>
      <div style="display:flex;justify-content:center;align-items:center;">
        <iframe width="100%" height="420" style="max-width:540px;border-radius:18px;border:none;box-shadow:0 2px 16px #0ea5e922;"
          src="https://embed.windy.com/embed2.html?lat=51.2&lon=10.4&detailLat=51.2&detailLon=10.4&width=650&height=420&zoom=6&level=surface&overlay=radar&product=radar&menu=&message=true&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1" title="Radar Live Gjermani" allowfullscreen></iframe>
      </div>
      <div class="satellite-caption">Burimi: <a href="https://www.windy.com/?radar,51.2,10.4,6" target="_blank" rel="noopener" style="color:#0ea5e9;">Windy.com Radar Live</a></div>
    </section>

    <section class="card">
      <div class="muted forecast-title">Grafikë e motit (5 ditë)</div>
      <canvas id="weatherChart" height="120"></canvas>
    </section>



    <section class="card">
      <div class="muted forecast-title">5 ditët në vijim</div>
      <div id="forecast" class="forecast"></div>
    </section>

    <div class="hint">Këshillë: Shtoje në Home Screen për ta përdorur si aplikacion.</div>
    <p class="sr-only" id="a11y"></p>
  </main>

  <!-- Leaflet JS dhe leaflet-providers (renditja e saktë) -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-providers@1.13.0/leaflet-providers.min.js"></script>

  <script>
  // ================== KODI KRYESOR ==================
  // Kosovo cities for quick access
  const kosovoCities = [
    "Prishtinë","Ferizaj","Pejë","Gjakovë","Mitrovicë","Gjilan","Prizren","Vushtrri","Podujevë","Fushë Kosovë","Suharekë","Rahovec","Drenas","Malishevë","Kamenicë","Istog","Deçan","Dragash","Lipjan","Kaçanik","Shtime","Klinë","Skenderaj","Obiliq","Viti","Juniku","Hani i Elezit","Zubin Potok","Zveçan","Leposaviq","Graçanicë","Mamusha","Partesh","Ranillug"
  ];
  // Germany cities for quick access (major cities)
  const germanyCities = [
    "Berlin","Hamburg","München","Köln","Frankfurt am Main","Stuttgart","Düsseldorf","Dortmund","Essen","Leipzig","Bremen","Dresden","Hannover","Nürnberg","Duisburg","Bochum","Wuppertal","Bielefeld","Bonn","Münster","Karlsruhe","Mannheim","Augsburg","Wiesbaden","Gelsenkirchen","Mönchengladbach","Braunschweig","Chemnitz","Kiel","Aachen"
  ];
  // Manual coordinates for Kosovo cities
  const kosovoCityCoords = {
    "Prishtinë": {lat: 42.6629, lon: 21.1655},
    "Ferizaj": {lat: 42.3706, lon: 21.1550},
    "Pejë": {lat: 42.6591, lon: 20.2883},
    "Gjakovë": {lat: 42.3803, lon: 20.4308},
    "Mitrovicë": {lat: 42.8900, lon: 20.8667},
    "Gjilan": {lat: 42.4634, lon: 21.4691},
    "Prizren": {lat: 42.2139, lon: 20.7417},
    "Vushtrri": {lat: 42.8231, lon: 20.9675},
    "Podujevë": {lat: 42.9131, lon: 21.1925},
    "Fushë Kosovë": {lat: 42.6378, lon: 21.0961},
    "Suharekë": {lat: 42.3586, lon: 20.8250},
    "Rahovec": {lat: 42.4000, lon: 20.6547},
    "Drenas": {lat: 42.6372, lon: 20.8022},
    "Malishevë": {lat: 42.4822, lon: 20.7456},
    "Kamenicë": {lat: 42.5767, lon: 21.5806},
    "Istog": {lat: 42.7800, lon: 20.4872},
    "Deçan": {lat: 42.5461, lon: 20.2917},
    "Dragash": {lat: 42.0667, lon: 20.6500},
    "Lipjan": {lat: 42.5306, lon: 21.1222},
    "Kaçanik": {lat: 42.2322, lon: 21.2592},
    "Shtime": {lat: 42.4333, lon: 21.0400},
    "Klinë": {lat: 42.6211, lon: 20.5761},
    "Skenderaj": {lat: 42.7461, lon: 20.7931},
    "Obiliq": {lat: 42.6861, lon: 21.0772},
    "Viti": {lat: 42.3200, lon: 21.3581},
    "Juniku": {lat: 42.4847, lon: 20.2772},
    "Hani i Elezit": {lat: 42.2000, lon: 21.3000},
    "Zubin Potok": {lat: 43.1000, lon: 20.6900},
    "Zveçan": {lat: 42.9000, lon: 20.8400},
    "Leposaviq": {lat: 43.1000, lon: 20.8000},
    "Graçanicë": {lat: 42.6217, lon: 21.1942},
    "Mamusha": {lat: 42.3272, lon: 20.7472},
    "Partesh": {lat: 42.3861, lon: 21.3761},
    "Ranillug": {lat: 42.5611, lon: 21.6181}
  };
  // ========== Leaflet Map + Live Location Marker ===========
  let map, liveMarker;
  let langSelect, countrySelect;
  // ================== Përkthimet ==================
  const translations = {
    sq: {
      searching_city: "Duke kërkuar qytetin…",
      city_not_found: "Qyteti nuk u gjet.",
      enter_city: "Shkruaj emrin e qytetit.",
      loading: "Duke ngarkuar…",
      updated: "U përditësua me sukses.",
      gps_not_supported: "Pajisja nuk mbështet GPS.",
      getting_location: "Duke marrë lokacionin…",
      location_failed: "S’u mor lokacioni: ",
      allow_gps: "Lejo GPS-in ose kërko një qytet.",
      weather_unavailable: "😕 Të dhënat e motit nuk janë të disponueshme.",
      forecast_unavailable: "😕 Të dhënat e parashikimit nuk janë të disponueshme.",
      temp: "Temp",
      min: "Min",
      max: "Max",
      humidity: "Lagështi",
      pressure: "Presion",
      precipitation: "Reshje",
      wind: "Era",
      winddir: "Drejtimi",
      sunrise: "Lindja",
      sunset: "Perëndimi"
    },
    en: {
      searching_city: "Searching city…",
      city_not_found: "City not found.",
      enter_city: "Enter city name.",
      loading: "Loading…",
      updated: "Updated successfully.",
      gps_not_supported: "Device does not support GPS.",
      getting_location: "Getting location…",
      location_failed: "Location failed: ",
      allow_gps: "Allow GPS or search a city.",
      weather_unavailable: "😕 Weather data not available.",
      forecast_unavailable: "😕 Forecast data not available.",
      temp: "Temp",
      min: "Min",
      max: "Max",
      humidity: "Humidity",
      pressure: "Pressure",
      precipitation: "Precipitation",
      wind: "Wind",
      winddir: "Direction",
      sunrise: "Sunrise",
      sunset: "Sunset"
    },
    de: {
      searching_city: "Stadt wird gesucht…",
      city_not_found: "Stadt nicht gefunden.",
      enter_city: "Stadtname eingeben.",
      loading: "Lädt…",
      updated: "Erfolgreich aktualisiert.",
      gps_not_supported: "Gerät unterstützt kein GPS.",
      getting_location: "Standort wird ermittelt…",
      location_failed: "Standort fehlgeschlagen: ",
      allow_gps: "GPS erlauben oder Stadt suchen.",
      weather_unavailable: "😕 Wetterdaten nicht verfügbar.",
      forecast_unavailable: "😕 Vorhersagedaten nicht verfügbar.",
      temp: "Temp",
      min: "Min",
      max: "Max",
      humidity: "Luftfeuchte",
      pressure: "Luftdruck",
      precipitation: "Niederschlag",
      wind: "Wind",
      winddir: "Richtung",
      sunrise: "Sonnenaufgang",
      sunset: "Sonnenuntergang"
    }
  };
  function lang(key) {
    const l = langSelect && langSelect.value || "sq";
    return (translations[l] && translations[l][key]) || translations["sq"][key] || key;
  }

  let radarLayer = null;
  let radarVisible = false;
  document.addEventListener("DOMContentLoaded", function() {
    langSelect = document.getElementById("langSelect");
    countrySelect = document.getElementById("countrySelect");
    // Populate city list and datalist based on country
    const cityListDiv = document.getElementById("cityList");
    const datalist = document.getElementById("cityListData");
    function updateCityList() {
      let cities = countrySelect.value === "DE" ? germanyCities : kosovoCities;
      if(cityListDiv) {
        cityListDiv.innerHTML = cities.map(city => `<button class=\"city-btn\" data-city=\"${city}\">${city}</button>`).join("");
      }
      if(datalist) {
        datalist.innerHTML = cities.map(city => `<option value=\"${city}\" />`).join("");
      }
      // Update city list title
      const cityListTitle = document.querySelector('.city-list-title');
      if (cityListTitle) {
        cityListTitle.textContent = countrySelect.value === "DE" ?
          (langSelect.value === "de" ? "Städte in Deutschland:" : (langSelect.value === "en" ? "Cities in Germany:" : "Qytetet e Gjermanisë:")) :
          (langSelect.value === "de" ? "Städte im Kosovo:" : (langSelect.value === "en" ? "Cities in Kosovo:" : "Qytetet e Kosovës:"));
      }
    }
    countrySelect.addEventListener("change", updateCityList);
    langSelect.addEventListener("change", updateCityList);
    updateCityList();
    if(cityListDiv) {
      cityListDiv.addEventListener("click", async function(e) {
        if(e.target && e.target.matches(".city-btn")) {
          q.value = e.target.dataset.city;
          try {
            setStatus(lang("searching_city"), true);
            const {lat,lon,label} = await searchCityByName(q.value);
            await loadByCoords(lat,lon,label);
          } catch(err){
            setStatus(err.message||lang("city_not_found"));
          }
        }
      });
    }
    // Init map
    if (document.getElementById('map')) {
      // Responsive map container for mobile
      const mapDiv = document.getElementById('map');
      mapDiv.classList.add('satellite-map');
      map = L.map('map', {
        zoomControl: true,
        attributionControl: true,
        tap: true,
        dragging: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        touchZoom: true
      }).setView([42.6, 21.0], 8);
      // Esri World Imagery (satelitor, falas për përdorim jo-komercial)
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        minZoom: 6,
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      }).addTo(map);
      // Overlay për rrugë dhe kufij (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        minZoom: 6,
        opacity: 0.4,
        attribution: false
      }).addTo(map);
      // Rectangle for Kosovo
      L.rectangle([[41.8, 20.9], [43, 21.9]], {color: "#0ea5e9", weight: 2, fillOpacity: 0}).addTo(map);

      // Radar toggle logic
      const radarToggle = document.getElementById('radarToggle');
      const radarStatus = document.getElementById('radarStatus');
      function updateRadarButton() {
        radarToggle.textContent = radarVisible ? "Fshih Radar" : "Shfaq Radar";
        radarStatus.textContent = radarVisible ? "Radar aktiv (RainViewer)" : "Radar i fikur";
      }
      function addRadarLayer() {
        if (radarLayer) return;
        radarLayer = L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast/{z}/{x}/{y}/2/1_1.png', {
          opacity: 0.7,
          zIndex: 100,
          attribution: 'Radar &copy; RainViewer'
        });
        radarLayer.addTo(map);
      }
      function removeRadarLayer() {
        if (radarLayer) {
          map.removeLayer(radarLayer);
          radarLayer = null;
        }
      }
      if (radarToggle) {
        radarToggle.addEventListener('click', function() {
          radarVisible = !radarVisible;
          if (radarVisible) {
            addRadarLayer();
          } else {
            removeRadarLayer();
          }
          updateRadarButton();
        });
        updateRadarButton();
      }
    }
  });

  // Funksion për të shfaqur markerin e live location
  async function showLiveLocation(lat, lon, label) {
    if (!map) return;
    if (liveMarker) {
      map.removeLayer(liveMarker);
    }
    liveMarker = L.marker([lat, lon], {icon: L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    })}).addTo(map);
    liveMarker.bindPopup(label || "Lokacioni im").openPopup();
    map.setView([lat, lon], 12);
  }

  // ================== Konfigurimi ==================
  const GEO_URL = "https://geocoding-api.open-meteo.com/v1";
  const WX_URL  = "https://api.open-meteo.com/v1/forecast";

  // Hartë WMO -> përshkrim + emoji në 3 gjuhë
  const WMO = new Map([
    [0,  {sq: ["Qiell i kthjellët","☀️"], en: ["Clear sky","☀️"], de: ["Klarer Himmel","☀️"]}],
    [1,  {sq: ["Kryesisht kthjellët","🌤️"], en: ["Mainly clear","🌤️"], de: ["Meist klar","🌤️"]}],
    [2,  {sq: ["Më pjesë me re","⛅"], en: ["Partly cloudy","⛅"], de: ["Teilweise bewölkt","⛅"]}],
    [3,  {sq: ["Me re/mbuluar","☁️"], en: ["Overcast","☁️"], de: ["Bedeckt","☁️"]}],
    [45, {sq: ["Mjegull","🌫️"], en: ["Fog","🌫️"], de: ["Nebel","🌫️"]}],
    [48, {sq: ["Mjegull me ngricë","🌫️"], en: ["Depositing rime fog","🌫️"], de: ["Reifnebel","🌫️"]}],
    [51, {sq: ["Siçak e lehtë","🌦️"], en: ["Light drizzle","🌦️"], de: ["Leichter Nieselregen","🌦️"]}],
    [53, {sq: ["Siçak mesatare","🌦️"], en: ["Moderate drizzle","🌦️"], de: ["Mäßiger Nieselregen","🌦️"]}],
    [55, {sq: ["Siçak e dendur","🌧️"], en: ["Dense drizzle","🌧️"], de: ["Starker Nieselregen","🌧️"]}],
    [56, {sq: ["Siçak ngrirëse lehtë","🌧️"], en: ["Light freezing drizzle","🌧️"], de: ["Leichter gefrierender Nieselregen","🌧️"]}],
    [57, {sq: ["Siçak ngrirëse dendur","🌧️"], en: ["Dense freezing drizzle","🌧️"], de: ["Starker gefrierender Nieselregen","🌧️"]}],
    [61, {sq: ["Shi i lehtë","🌦️"], en: ["Slight rain","🌦️"], de: ["Leichter Regen","🌦️"]}],
    [63, {sq: ["Shi mesatar","🌧️"], en: ["Moderate rain","🌧️"], de: ["Mäßiger Regen","🌧️"]}],
    [65, {sq: ["Shi i dendur","🌧️"], en: ["Heavy rain","🌧️"], de: ["Starker Regen","🌧️"]}],
    [66, {sq: ["Shi ngrirës i lehtë","🌧️"], en: ["Light freezing rain","🌧️"], de: ["Leichter gefrierender Regen","🌧️"]}],
    [67, {sq: ["Shi ngrirës i dendur","🌧️"], en: ["Heavy freezing rain","🌧️"], de: ["Starker gefrierender Regen","🌧️"]}],
    [71, {sq: ["Borë e lehtë","🌨️"], en: ["Slight snow fall","🌨️"], de: ["Leichter Schneefall","🌨️"]}],
    [73, {sq: ["Borë mesatare","🌨️"], en: ["Moderate snow fall","🌨️"], de: ["Mäßiger Schneefall","🌨️"]}],
    [75, {sq: ["Borë e dendur","❄️"], en: ["Heavy snow fall","❄️"], de: ["Starker Schneefall","❄️"]}],
    [77, {sq: ["Kokrriza bore","❄️"], en: ["Snow grains","❄️"], de: ["Schneekörner","❄️"]}],
    [80, {sq: ["Shtr. shiu të lehta","🌦️"], en: ["Slight rain showers","🌦️"], de: ["Leichte Regenschauer","🌦️"]}],
    [81, {sq: ["Shtr. mesatare","🌧️"], en: ["Moderate rain showers","🌧️"], de: ["Mäßige Regenschauer","🌧️"]}],
    [82, {sq: ["Shtr. të forta","🌧️"], en: ["Violent rain showers","🌧️"], de: ["Heftige Regenschauer","🌧️"]}],
    [85, {sq: ["Shtr. bore të lehta","🌨️"], en: ["Slight snow showers","🌨️"], de: ["Leichte Schneeschauer","🌨️"]}],
    [86, {sq: ["Shtr. bore të forta","❄️"], en: ["Heavy snow showers","❄️"], de: ["Starke Schneeschauer","❄️"]}],
    [95, {sq: ["Stuhi","⛈️"], en: ["Thunderstorm","⛈️"], de: ["Gewitter","⛈️"]}],
    [96, {sq: ["Stuhi me breshër","⛈️"], en: ["Thunderstorm with hail","⛈️"], de: ["Gewitter mit Hagel","⛈️"]}],
    [99, {sq: ["Stuhi me breshër të fortë","⛈️"], en: ["Severe thunderstorm with hail","⛈️"], de: ["Schweres Gewitter mit Hagel","⛈️"]}]
  ]);

  const q = document.getElementById("q");
  const btnSearch = document.getElementById("btnSearch");
  const btnGeo = document.getElementById("btnGeo");
  const currentEl = document.getElementById("current");
  const forecastEl = document.getElementById("forecast");
  const statusEl = document.getElementById("status");
  const a11yEl = document.getElementById("a11y");

  function speak(msg){
    a11yEl.textContent = msg;
  }
  function setStatus(msg, loading=false){
    statusEl.textContent = msg || "";
    statusEl.classList.toggle("loading", !!loading);
  }
  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return new Intl.DateTimeFormat("sq-AL",{weekday:"long",day:"2-digit",month:"short"}).format(d);
    }catch{ return iso; }
  }
  function wmoText(code){
    const l = langSelect && langSelect.value || "sq";
    const entry = WMO.get(code);
    if (!entry) return ["(p/. njoftuar)","❔"];
    return entry[l] || entry["sq"];
  }

  async function searchCityByName(name) {
    // First, check if city is in Kosovo list with coordinates
    if (countrySelect.value === "KS" && kosovoCityCoords[name]) {
      return {
        lat: kosovoCityCoords[name].lat,
        lon: kosovoCityCoords[name].lon,
        label: name + ", Kosovë"
      };
    }
    // Use Open-Meteo Geocoding API with selected language and country
    const langCode = langSelect.value || "sq";
    let url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=${langCode}&format=json`;
    if (countrySelect.value === "DE") url += "&country=DE";
    if (countrySelect.value === "KS") url += "&country=XK";
    const res = await fetch(url);
    if (!res.ok) throw new Error(lang("city_not_found"));
    const data = await res.json();
    if (!data.results || !data.results[0]) throw new Error(lang("city_not_found"));
    return {
      lat: data.results[0].latitude,
      lon: data.results[0].longitude,
      label: data.results[0].name + (data.results[0].country ? ", " + data.results[0].country : "")
    };
  }

  async function reverseLookup(lat, lon){
    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=sq&format=json`);
    if(!res.ok) return null;
    const data = await res.json();
    const c = data && data.results && data.results[0];
    return c ? [c.name, c.admin1, c.country_code].filter(Boolean).join(", ") : `Koord. ${lat.toFixed(2)}, ${lon.toFixed(2)}`;
  }

  async function getWeather(lat, lon) {
    // Përdor Open-Meteo Weather API direkt
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,pressure_msl,precipitation,precipitation_probability,weathercode,windspeed_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_hours,precipitation_probability_max,sunrise,sunset,weathercode&timezone=auto`;
    let res;
    try {
      res = await fetch(url);
    } catch (err) {
      throw new Error("Nuk u lidh me serverin e motit. Kontrollo internetin, adblock ose lejo HTTPS.");
    }
    if (!res.ok) {
      if (res.status === 0) {
        throw new Error("Nuk u lidh me serverin e motit. Kontrollo lidhjen ose lejo HTTPS.");
      }
      throw new Error("Gabim në marrjen e motit (" + res.status + ").");
    }
    return res.json();
  }

  function renderCurrent(place, wx){
    if (!wx || !wx.current_weather || typeof wx.current_weather.temperature === 'undefined') {
      currentEl.innerHTML = `<div class="card error">😕 Të dhënat e motit nuk janë të disponueshme.</div>`;
      return;
    }
    const c = wx.current_weather;
    const [txt, emoji] = wmoText(c.weathercode);
    // Find the current hour index for humidity, pressure, precipitation
    let humidity = "-", pressure = "-", precipitation = "-";
    if (wx.hourly && wx.hourly.time && Array.isArray(wx.hourly.time) && typeof c.time === 'string') {
      const idx = wx.hourly.time.findIndex(t => t.startsWith(c.time.slice(0,13)));
      if(idx !== -1) {
        humidity = wx.hourly.relative_humidity_2m && wx.hourly.relative_humidity_2m[idx] !== undefined ? wx.hourly.relative_humidity_2m[idx] + "%" : "-";
        pressure = wx.hourly.pressure_msl && wx.hourly.pressure_msl[idx] !== undefined ? wx.hourly.pressure_msl[idx] + " hPa" : "-";
        precipitation = wx.hourly.precipitation && wx.hourly.precipitation[idx] !== undefined ? wx.hourly.precipitation[idx] + " mm" : "-";
      }
    }
    // Sunrise/sunset for today
    let sunrise = "-", sunset = "-";
    if (wx.daily && wx.daily.sunrise && wx.daily.sunset) {
      sunrise = wx.daily.sunrise[0] ? wx.daily.sunrise[0].slice(11,16) : "-";
      sunset = wx.daily.sunset[0] ? wx.daily.sunset[0].slice(11,16) : "-";
    }
    // Min/max temp for today
    let tmin = "-", tmax = "-";
    if (wx.daily && wx.daily.temperature_2m_min && wx.daily.temperature_2m_max) {
      tmin = wx.daily.temperature_2m_min[0] !== undefined ? Math.round(wx.daily.temperature_2m_min[0]) + "°C" : "-";
      tmax = wx.daily.temperature_2m_max[0] !== undefined ? Math.round(wx.daily.temperature_2m_max[0]) + "°C" : "-";
    }
    currentEl.innerHTML = `
      <div>
        <div class="place">${place}</div>
        <div class="desc">${fmtDate(c.time)} · ${txt} ${emoji}</div>
        <div class="meta">
          <span class="badge">🌡️ ${lang('temp')}: ${Math.round(c.temperature)}°C</span>
          <span class="badge">🔻 ${lang('min')}: ${tmin}</span>
          <span class="badge">🔺 ${lang('max')}: ${tmax}</span>
          <span class="badge">💧 ${lang('humidity')}: ${humidity}</span>
          <span class="badge">🌡️ ${lang('pressure')}: ${pressure}</span>
          <span class="badge">🌧️ ${lang('precipitation')}: ${precipitation}</span>
        </div>
        <div class="meta">
          <span class="badge">💨 ${lang('wind')}: ${Math.round(c.windspeed)} km/h</span>
          <span class="badge">🧭 ${lang('winddir')}: ${Math.round(c.winddirection)}°</span>
        </div>
        <div class="meta">
          <span class="badge">🌅 ${lang('sunrise')}: ${sunrise}</span>
          <span class="badge">🌇 ${lang('sunset')}: ${sunset}</span>
        </div>
      </div>
      <div class="temp">${Math.round(c.temperature)}°C</div>
    `;
  }



  function renderForecast(wx){
    if (!wx || !wx.daily || !Array.isArray(wx.daily.time)) {
      forecastEl.innerHTML = `<div class="card error">😕 Të dhënat e parashikimit nuk janë të disponueshme.</div>`;
      if (window.weatherChart && typeof window.weatherChart.destroy === 'function') window.weatherChart.destroy();
      return;
    }
    const d = wx.daily;
    forecastEl.innerHTML = "";
    const labels = [];
    const tmaxs = [];
    const tmins = [];
    const humidities = [];
    const pressures = [];
    const precipProbs = [];
    for(let i=1; i<Math.min(d.time.length,6); i++){
      const day = d.time[i];
      const tmax = Math.round(d.temperature_2m_max[i]);
      const tmin = Math.round(d.temperature_2m_min[i]);
      const [txt, emoji] = wmoText(d.weathercode[i]);
      const precip = d.precipitation_sum && d.precipitation_sum[i] !== undefined ? d.precipitation_sum[i] + " mm" : "-";
      const precipHours = d.precipitation_hours && d.precipitation_hours[i] !== undefined ? d.precipitation_hours[i] + "h" : "-";
      const precipProb = d.precipitation_probability_max && d.precipitation_probability_max[i] !== undefined ? d.precipitation_probability_max[i] + "%" : "-";
      const sunrise = d.sunrise && d.sunrise[i] ? d.sunrise[i].slice(11,16) : "-";
      const sunset = d.sunset && d.sunset[i] ? d.sunset[i].slice(11,16) : "-";
      let avgHumidity = "-", avgPressure = "-";
      let precipStart = "-", strongWindStart = "-", hailWarning = "";
      let hottestHour = null, hottestTemp = null;
      if (wx.hourly && wx.hourly.relative_humidity_2m && wx.hourly.pressure_msl && Array.isArray(wx.hourly.time)) {
        const dayStr = day.slice(0,10);
        const indices = wx.hourly.time
          .map((t, idx) => t.startsWith(dayStr) ? idx : -1)
          .filter(idx => idx !== -1);
        if (indices.length) {
          const h = indices.map(idx => wx.hourly.relative_humidity_2m[idx]);
          const p = indices.map(idx => wx.hourly.pressure_msl[idx]);
          avgHumidity = Math.round(h.reduce((a,b)=>a+b,0)/h.length) + "%";
          avgPressure = Math.round(p.reduce((a,b)=>a+b,0)/p.length) + " hPa";
          if (wx.hourly.precipitation) {
            const precipIdx = indices.find(idx => wx.hourly.precipitation[idx] > 0);
            if (typeof precipIdx === 'number' && precipIdx !== -1) {
              precipStart = wx.hourly.time[precipIdx].slice(11,16);
            }
          }
          if (wx.hourly.windspeed_10m) {
            const windIdx = indices.find(idx => wx.hourly.windspeed_10m[idx] >= 40);
            if (typeof windIdx === 'number' && windIdx !== -1) {
              strongWindStart = wx.hourly.time[windIdx].slice(11,16);
            }
          }
          // Hail warning: check for weathercode 96 or 99 in this day
          if (wx.hourly.weathercode) {
            const hailIdx = indices.find(idx => wx.hourly.weathercode[idx] === 96 || wx.hourly.weathercode[idx] === 99);
            if (typeof hailIdx === 'number' && hailIdx !== -1) {
              hailWarning = '<span class="badge" style="background:#fbbf24;color:#222;">⚠️ Breshër i mundshëm!</span>';
            }
          }
          // Find hottest hour
          if (wx.hourly.temperature_2m) {
            let maxTemp = -100, maxIdx = -1;
            indices.forEach(idx => {
              if (wx.hourly.temperature_2m[idx] > maxTemp) {
                maxTemp = wx.hourly.temperature_2m[idx];
                maxIdx = idx;
              }
            });
            if (maxIdx !== -1) {
              hottestHour = wx.hourly.time[maxIdx].slice(11,16);
              hottestTemp = Math.round(wx.hourly.temperature_2m[maxIdx]);
            }
          }
        }
      }
      const el = document.createElement("div");
      el.className = "day";
      el.innerHTML = `
        <div>${fmtDate(day)}</div>
        <div class="emoji">${emoji}</div>
        <div class="desc">${txt}</div>
        <div class="t">${tmax}° / ${tmin}°</div>
        <div class="meta">
          <span class="badge">💧 Lagështi: ${avgHumidity}</span>
          <span class="badge">🌡️ Presion: ${avgPressure}</span>
        </div>
        <div class="meta">
          <span class="badge">🌧️ Reshje: ${precip}</span>
          <span class="badge">⏱️ Orë reshje: ${precipHours}</span>
          <span class="badge">% Reshje: ${precipProb}</span>
        </div>
        <div class="meta">
          <span class="badge">🌅 Lindja: ${sunrise}</span>
          <span class="badge">🌇 Perëndimi: ${sunset}</span>
        </div>
        <div class="meta">
          <span class="badge">🕒 Fillon shiu: ${precipStart}</span>
          <span class="badge">💨 Erë të forta: ${strongWindStart}</span>
        </div>
        <div class="meta">
          ${hailWarning}
          ${hottestHour !== null ? `<span class="badge" style="background:#f87171;color:#fff;">🔥 Piku i nxehtësisë: ${hottestHour} (${hottestTemp}°C)</span>` : ''}
        </div>
      `;
      forecastEl.appendChild(el);
      labels.push(fmtDate(day));
      tmaxs.push(tmax);
      tmins.push(tmin);
      humidities.push(avgHumidity === "-" ? null : parseInt(avgHumidity));
      pressures.push(avgPressure === "-" ? null : parseInt(avgPressure));
      precipProbs.push(precipProb === "-" ? null : parseInt(precipProb));
    }
    if (window.weatherChart && typeof window.weatherChart.destroy === 'function') window.weatherChart.destroy();
    const ctx = document.getElementById('weatherChart').getContext('2d');
    window.weatherChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Temp. Max',
            data: tmaxs,
            borderColor: '#0ea5e9',
            backgroundColor: '#0ea5e955',
            tension: 0.3,
            yAxisID: 'y',
          },
          {
            label: 'Temp. Min',
            data: tmins,
            borderColor: '#0369a1',
            backgroundColor: '#0369a155',
            tension: 0.3,
            yAxisID: 'y',
          },
          {
            label: 'Lagështi (%)',
            data: humidities,
            borderColor: '#22d3ee',
            backgroundColor: '#22d3ee55',
            borderDash: [5,5],
            tension: 0.3,
            yAxisID: 'y1',
          },
          {
            label: 'Presion (hPa)',
            data: pressures,
            borderColor: '#fbbf24',
            backgroundColor: '#fbbf2455',
            borderDash: [2,2],
            tension: 0.3,
            yAxisID: 'y2',
          },
          {
            label: '% Reshje',
            data: precipProbs,
            borderColor: '#6366f1',
            backgroundColor: '#6366f155',
            borderDash: [3,3],
            tension: 0.3,
            yAxisID: 'y3',
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Temperatura (°C)' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Lagështi (%)' }
          },
          y2: {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Presion (hPa)' },
            offset: true
          },
          y3: {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            title: { display: true, text: '% Reshje' },
            offset: true,
            min: 0,
            max: 100
          }
        }
      }
    });
  }

  function checkExtremeWeather(wx) {
    if (!wx || !wx.current_weather) return;
    const temp = wx.current_weather.temperature;
    const wind = wx.current_weather.windspeed;
    const code = wx.current_weather.weathercode;
    let msg = "";
    let healthMsg = "";
    if (temp >= 35) {
      msg = "⚠️ Paralajmërim: Temperaturë shumë e lartë!";
      healthMsg = "Kujdes! Pini ujë shpesh, qëndroni në hije dhe shmangni ekspozimin në diell gjatë orëve të pikut."
    }
    if (temp <= -10) {
      msg = "⚠️ Paralajmërim: Temperaturë shumë e ulët!";
      healthMsg = "Kujdes! Vishuni ngrohtë, shmangni qëndrimin e gjatë jashtë dhe kontrolloni të moshuarit/fëmijët."
    }
    if (wind >= 60) {
      msg = "⚠️ Paralajmërim: Erëra të forta!";
      healthMsg = "Kujdes! Qëndroni larg objekteve të pa fiksuara dhe mos qëndroni afër pemëve të mëdha."
    }
    if ([95,96,99].includes(code)) {
      msg = "⚠️ Paralajmërim: Stuhi!";
      healthMsg = "Kujdes! Qëndroni brenda, shmangni udhëtimet dhe mos përdorni pajisje elektrike gjatë stuhisë.";
    }
    if ([96,99].includes(code)) {
      healthMsg = "Rrezik breshëri! Parkoni automjetin në vende të mbrojtura dhe qëndroni larg dritareve.";
    }
    if (msg) alert(msg);
    if (healthMsg && "Notification" in window && Notification.permission === "granted") {
      new Notification("Rekomandim shëndetësor", { body: healthMsg, icon: "icons/icon-192x192.png" });
    } else if (healthMsg && "Notification" in window && Notification.permission !== "denied") {
      Notification.requestPermission().then(function(permission) {
        if (permission === "granted") {
          new Notification("Rekomandim shëndetësor", { body: healthMsg, icon: "icons/icon-192x192.png" });
        }
      });
    }
  }

  async function loadByCoords(lat, lon, labelOverride){
    try{
      setStatus("Duke ngarkuar…", true);
      const [wx, labelAuto] = await Promise.all([
        getWeather(lat, lon),
        labelOverride ? Promise.resolve(labelOverride) : reverseLookup(lat, lon)
      ]);
      const place = labelOverride || labelAuto || "Lokacioni im";
  renderCurrent(place, wx);
  renderForecast(wx);
      checkExtremeWeather(wx);
      setStatus("U përditësua me sukses.");
      speak(`Moti për ${place}: ${Math.round(wx.current_weather.temperature)} gradë celsius.`);
      if (typeof showLiveLocation === 'function') {
        showLiveLocation(lat, lon, place);
      }
    }catch(err){
      setStatus(err.message || "Ndodhi një gabim.");
      currentEl.innerHTML = `<div class=\"card error\">😕 ${err.message||"Gabim"}<br><small>Kontrollo lidhjen me internet, adblock ose HTTPS. Provo të rifreskosh faqen ose të fshish cache.</small></div>`;
    }
  }

  // ============= Ngjarjet UI =============
  btnSearch.addEventListener("click", async ()=>{
    const name = q.value.trim();
    if(!name) { setStatus(lang("enter_city")); return; }
    try{
      setStatus(lang("searching_city"), true);
      const {lat,lon,label} = await searchCityByName(name);
      await loadByCoords(lat,lon,label);
    }catch(err){
      setStatus(err.message||lang("city_not_found"));
    }
  });

  q.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") btnSearch.click();
  });

  btnGeo.addEventListener("click", ()=>{
    if(!navigator.geolocation) {
      setStatus(lang("gps_not_supported"));
      return;
    }
    setStatus(lang("getting_location"), true);
    navigator.geolocation.getCurrentPosition(
      async pos => {
        // Merr emrin e vendndodhjes për label
        let label = await reverseLookup(pos.coords.latitude, pos.coords.longitude);
        await loadByCoords(pos.coords.latitude, pos.coords.longitude, label);
      },
      err => setStatus(lang("location_failed") + (err.message||"lejet e bllokuara"))
    );
  });

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos => loadByCoords(pos.coords.latitude, pos.coords.longitude),
      () => setStatus(lang("allow_gps"))
    );
  } else {
    setStatus(lang("allow_gps"));
  }

  setInterval(() => {
    if(q.value) {
      btnSearch.click();
    }
  }, 600000);
  </script>


  
  </script>
  <!-- manifest.json është tashmë i përfshirë më lart -->
  <script>
  // Regjistro service worker vetëm në prodhim, mos e çregjistro automatikisht
  if('serviceWorker' in navigator){
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js', {scope: './'})
        .then(function(reg){ /* sukses */ })
        .catch(function(e){ /* silent fail */ });
    });
  }
  </script>
<script>
  // Dark mode automatik nga sistemi
  if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    document.documentElement.classList.add('dark');
  }
</script>
</body>
</html>



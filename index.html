<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Moti â€“ App</title>
  <!-- 'meta[name=theme-color]' is not supported by Firefox, Firefox for Android, Opera -->
  <gi  <!-- Apple Touch Icon for iOS Home Screen -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <meta name="msapplication-TileColor" content="#0ea5e9" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <!-- For Safari/iOS PWA theme color -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Moti â€“ App" />
  <link rel="stylesheet" href="style.css">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="app" role="application" aria-label="Aplikacioni i motit">
    <h1>ğŸŒ¤ï¸ Parashikimi i Motit</h1>

    <div class="row" role="search">
      <input id="q" type="search" placeholder="KÃ«rko qytetâ€¦ p.sh. PrishtinÃ«" autocomplete="off" list="citiesKS" />
      <datalist id="citiesKS">
        <option value="PrishtinÃ«" />
        <option value="Ferizaj" />
        <option value="PejÃ«" />
        <option value="GjakovÃ«" />
        <option value="MitrovicÃ«" />
        <option value="Gjilan" />
        <option value="Prizren" />
        <option value="Vushtrri" />
        <option value="PodujevÃ«" />
        <option value="FushÃ« KosovÃ«" />
        <option value="SuharekÃ«" />
        <option value="Rahovec" />
        <option value="Drenas" />
        <option value="MalishevÃ«" />
        <option value="KamenicÃ«" />
        <option value="Istog" />
        <option value="DeÃ§an" />
        <option value="Dragash" />
        <option value="Lipjan" />
        <option value="KaÃ§anik" />
        <option value="Shtime" />
        <option value="KlinÃ«" />
        <option value="Skenderaj" />
        <option value="Obiliq" />
        <option value="Viti" />
        <option value="Juniku" />
        <option value="Hani i Elezit" />
        <option value="Zubin Potok" />
        <option value="ZveÃ§an" />
        <option value="Leposaviq" />
        <option value="GraÃ§anicÃ«" />
        <option value="Mamusha" />
        <option value="Partesh" />
        <option value="Ranillug" />
      </datalist>
      <button id="btnSearch" type="button" title="KÃ«rko">KÃ«rko</button>
      <button id="btnGeo" type="button" title="PÃ«rdor lokacionin tim">GPS</button>
    </div>

    <div class="city-list-wrap">
      <div class="city-list-title">Qytetet e KosovÃ«s:</div>
      <div class="city-list" id="cityList"></div>
      <div id="status" class="status"></div>
    </div>
  <script>
    // Kosovo cities for quick access
    const kosovoCities = [
      "PrishtinÃ«","Ferizaj","PejÃ«","GjakovÃ«","MitrovicÃ«","Gjilan","Prizren","Vushtrri","PodujevÃ«","FushÃ« KosovÃ«","SuharekÃ«","Rahovec","Drenas","MalishevÃ«","KamenicÃ«","Istog","DeÃ§an","Dragash","Lipjan","KaÃ§anik","Shtime","KlinÃ«","Skenderaj","Obiliq","Viti","Juniku","Hani i Elezit","Zubin Potok","ZveÃ§an","Leposaviq","GraÃ§anicÃ«","Mamusha","Partesh","Ranillug"
    ];
    // Manual coordinates for Kosovo cities
    const kosovoCityCoords = {
      "PrishtinÃ«": {lat: 42.6629, lon: 21.1655},
      "Ferizaj": {lat: 42.3706, lon: 21.1550},
      "PejÃ«": {lat: 42.6591, lon: 20.2883},
      "GjakovÃ«": {lat: 42.3803, lon: 20.4308},
      "MitrovicÃ«": {lat: 42.8900, lon: 20.8667},
      "Gjilan": {lat: 42.4634, lon: 21.4691},
      "Prizren": {lat: 42.2139, lon: 20.7417},
      "Vushtrri": {lat: 42.8231, lon: 20.9675},
      "PodujevÃ«": {lat: 42.9131, lon: 21.1925},
      "FushÃ« KosovÃ«": {lat: 42.6378, lon: 21.0961},
      "SuharekÃ«": {lat: 42.3586, lon: 20.8250},
      "Rahovec": {lat: 42.4000, lon: 20.6547},
      "Drenas": {lat: 42.6372, lon: 20.8022},
      "MalishevÃ«": {lat: 42.4822, lon: 20.7456},
      "KamenicÃ«": {lat: 42.5767, lon: 21.5806},
      "Istog": {lat: 42.7800, lon: 20.4872},
      "DeÃ§an": {lat: 42.5461, lon: 20.2917},
      "Dragash": {lat: 42.0667, lon: 20.6500},
      "Lipjan": {lat: 42.5306, lon: 21.1222},
      "KaÃ§anik": {lat: 42.2322, lon: 21.2592},
      "Shtime": {lat: 42.4333, lon: 21.0400},
      "KlinÃ«": {lat: 42.6211, lon: 20.5761},
      "Skenderaj": {lat: 42.7461, lon: 20.7931},
      "Obiliq": {lat: 42.6861, lon: 21.0772},
      "Viti": {lat: 42.3200, lon: 21.3581},
      "Juniku": {lat: 42.4847, lon: 20.2772},
      "Hani i Elezit": {lat: 42.2000, lon: 21.3000},
      "Zubin Potok": {lat: 43.1000, lon: 20.6900},
      "ZveÃ§an": {lat: 42.9000, lon: 20.8400},
      "Leposaviq": {lat: 43.1000, lon: 20.8000},
      "GraÃ§anicÃ«": {lat: 42.6217, lon: 21.1942},
      "Mamusha": {lat: 42.3272, lon: 20.7472},
      "Partesh": {lat: 42.3861, lon: 21.3761},
      "Ranillug": {lat: 42.5611, lon: 21.6181}
    };
    document.addEventListener("DOMContentLoaded", function() {
      const cityListDiv = document.getElementById("cityList");
      if(cityListDiv) {
        cityListDiv.innerHTML = kosovoCities.map(city => `<button class="city-btn" data-city="${city}">${city}</button>`).join("");
        cityListDiv.addEventListener("click", async function(e) {
          if(e.target && e.target.matches(".city-btn")) {
            q.value = e.target.dataset.city;
            // Kjo Ã«shtÃ« pjesa e re:
            try {
              setStatus("Duke kÃ«rkuar qytetinâ€¦", true);
              const {lat,lon,label} = await searchCityByName(q.value);
              await loadByCoords(lat,lon,label);
            } catch(err){
              setStatus(err.message||"Qyteti nuk u gjet.");
            }
          }
        });
      }
    });
  </script>


    <section id="current" class="card current" aria-live="polite"></section>

    <section class="card">
      <div class="muted forecast-title">Pamje satelitore interaktive (Google Maps)</div>
  <div id="map" class="satellite-map"></div>
      <div class="satellite-caption">Burimi: Google Maps Satellite</div>
    </section>

    <section class="card">
      <div class="muted forecast-title">GrafikÃ« e motit (5 ditÃ«)</div>
      <canvas id="weatherChart" height="120"></canvas>
    </section>

    <section class="card">
      <div class="muted forecast-title">5 ditÃ«t nÃ« vijim</div>
      <div id="forecast" class="forecast"></div>
    </section>

    <div class="hint">KÃ«shillÃ«: Shtoje nÃ« Home Screen pÃ«r ta pÃ«rdorur si aplikacion.</div>
    <p class="sr-only" id="a11y"></p>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.min.js"></script>
  <script>
    // ============= Leaflet Google Maps Satellite =============
    document.addEventListener("DOMContentLoaded", function() {
      if (document.getElementById('map')) {
        var map = L.map('map').setView([42.6, 21.0], 8);
        // Google Maps Satellite (via leaflet-providers)
        L.tileLayer.provider('GoogleSatellite', {
          maxZoom: 18,
          minZoom: 6,
        }).addTo(map);
        // Rectangle for Kosovo
        L.rectangle([[41.8, 20.9], [43, 21.9]], {color: "#0ea5e9", weight: 2, fillOpacity: 0}).addTo(map);
      }
    });
    // ================== Konfigurimi ==================
    const GEO_URL = "https://geocoding-api.open-meteo.com/v1";
    const WX_URL  = "https://api.open-meteo.com/v1/forecast";

    // HartÃ« WMO -> pÃ«rshkrim + emoji (nÃ« shqip)
    const WMO = new Map([
      [0,  ["Qiell i kthjellÃ«t","â˜€ï¸"]],
      [1,  ["Kryesisht kthjellÃ«t","ğŸŒ¤ï¸"]],
      [2,  ["MÃ« pjesÃ« me re","â›…"]],
      [3,  ["Me re/mbuluar","â˜ï¸"]],
      [45, ["Mjegull","ğŸŒ«ï¸"]],[48,["Mjegull me ngricÃ«","ğŸŒ«ï¸"]],
      [51, ["SiÃ§ak e lehtÃ«","ğŸŒ¦ï¸"]],[53,["SiÃ§ak mesatare","ğŸŒ¦ï¸"]],[55,["SiÃ§ak e dendur","ğŸŒ§ï¸"]],
      [56, ["SiÃ§ak ngrirÃ«se lehtÃ«","ğŸŒ§ï¸"]],[57,["SiÃ§ak ngrirÃ«se dendur","ğŸŒ§ï¸"]],
      [61, ["Shi i lehtÃ«","ğŸŒ¦ï¸"]],[63,["Shi mesatar","ğŸŒ§ï¸"]],[65,["Shi i dendur","ğŸŒ§ï¸"]],
      [66, ["Shi ngrirÃ«s i lehtÃ«","ğŸŒ§ï¸"]],[67,["Shi ngrirÃ«s i dendur","ğŸŒ§ï¸"]],
      [71, ["BorÃ« e lehtÃ«","ğŸŒ¨ï¸"]],[73,["BorÃ« mesatare","ğŸŒ¨ï¸"]],[75,["BorÃ« e dendur","â„ï¸"]],
      [77, ["Kokrriza bore","â„ï¸"]],
      [80, ["Shtr. shiu tÃ« lehta","ğŸŒ¦ï¸"]],[81,["Shtr. mesatare","ğŸŒ§ï¸"]],[82,["Shtr. tÃ« forta","ğŸŒ§ï¸"]],
      [85, ["Shtr. bore tÃ« lehta","ğŸŒ¨ï¸"]],[86,["Shtr. bore tÃ« forta","â„ï¸"]],
      [95, ["Stuhi","â›ˆï¸"]],[96,["Stuhi me breshÃ«r","â›ˆï¸"]],[99,["Stuhi me breshÃ«r tÃ« fortÃ«","â›ˆï¸"]]
    ]);

    const q = document.getElementById("q");
    const btnSearch = document.getElementById("btnSearch");
    const btnGeo = document.getElementById("btnGeo");
    const currentEl = document.getElementById("current");
    const forecastEl = document.getElementById("forecast");
    const statusEl = document.getElementById("status");
    const a11yEl = document.getElementById("a11y");

    function speak(msg){
      a11yEl.textContent = msg;
    }
    function setStatus(msg, loading=false){
      statusEl.textContent = msg || "";
      statusEl.classList.toggle("loading", !!loading);
    }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return new Intl.DateTimeFormat("sq-AL",{weekday:"long",day:"2-digit",month:"short"}).format(d);
      }catch{ return iso; }
    }
    function wmoText(code){
      return WMO.get(code) || ["(p/. njoftuar)","â”"];
    }

    async function searchCityByName(name) {
      // First, check if city is in Kosovo list with coordinates
      if (kosovoCityCoords[name]) {
        return {
          lat: kosovoCityCoords[name].lat,
          lon: kosovoCityCoords[name].lon,
          label: name + ", KosovÃ«"
        };
      }
      // Otherwise, use API
      const res = await fetch(`http://192.168.1.3:3001/api/geocode?name=${encodeURIComponent(name)}`);
      if (!res.ok) throw new Error("Qyteti nuk u gjet");
      return await res.json();
    }

    async function reverseLookup(lat, lon){
      const res = await fetch(`http://localhost:3001/api/reverse?lat=${lat}&lon=${lon}`);
      if(!res.ok) return null;
      const data = await res.json();
      const c = data && data.results && data.results[0];
      return c ? [c.name, c.admin1, c.country_code].filter(Boolean).join(", ") : `Koord. ${lat.toFixed(2)}, ${lon.toFixed(2)}`;
    }

    async function getWeather(lat, lon) {
      const res = await fetch(`http://localhost:3001/api/weather?lat=${lat}&lon=${lon}`);
      if (!res.ok) throw new Error("Gabim nÃ« marrjen e motit");
      return res.json();
    }

    async function getBulkWeather(locations) {
      const res = await fetch('http://192.168.1.3:3001/api/weather/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locations })
      });
      if (!res.ok) throw new Error("Gabim nÃ« marrjen e motit");
      return await res.json();
    }

    function renderCurrent(place, wx){
      if (!wx || !wx.current_weather || typeof wx.current_weather.temperature === 'undefined') {
        currentEl.innerHTML = `<div class="card error">ğŸ˜• TÃ« dhÃ«nat e motit nuk janÃ« tÃ« disponueshme.</div>`;
        return;
      }
      const c = wx.current_weather;
      const [txt, emoji] = wmoText(c.weathercode);
      // Find the current hour index for humidity, pressure, precipitation
      let humidity = "-", pressure = "-", precipitation = "-";
      if (wx.hourly && wx.hourly.time && Array.isArray(wx.hourly.time) && typeof c.time === 'string') {
        const idx = wx.hourly.time.findIndex(t => t.startsWith(c.time.slice(0,13)));
        if(idx !== -1) {
          humidity = wx.hourly.relative_humidity_2m && wx.hourly.relative_humidity_2m[idx] !== undefined ? wx.hourly.relative_humidity_2m[idx] + "%" : "-";
          pressure = wx.hourly.pressure_msl && wx.hourly.pressure_msl[idx] !== undefined ? wx.hourly.pressure_msl[idx] + " hPa" : "-";
          precipitation = wx.hourly.precipitation && wx.hourly.precipitation[idx] !== undefined ? wx.hourly.precipitation[idx] + " mm" : "-";
        }
      }
      // Sunrise/sunset for today
      let sunrise = "-", sunset = "-";
      if (wx.daily && wx.daily.sunrise && wx.daily.sunset) {
        sunrise = wx.daily.sunrise[0] ? wx.daily.sunrise[0].slice(11,16) : "-";
        sunset = wx.daily.sunset[0] ? wx.daily.sunset[0].slice(11,16) : "-";
      }
      currentEl.innerHTML = `
        <div>
          <div class="place">${place}</div>
          <div class="desc">${fmtDate(c.time)} Â· ${txt} ${emoji}</div>
          <div class="meta">
            <span class="badge">ğŸŒ¡ï¸ Temp: ${Math.round(c.temperature)}Â°C</span>
            <span class="badge">ğŸ’§ LagÃ«shti: ${humidity}</span>
            <span class="badge">ğŸŒ¡ï¸ Presion: ${pressure}</span>
            <span class="badge">ğŸŒ§ï¸ Reshje: ${precipitation}</span>
          </div>
          <div class="meta">
            <span class="badge">ğŸ’¨ Era: ${Math.round(c.windspeed)} km/h</span>
            <span class="badge">ğŸ§­ Drejtimi: ${Math.round(c.winddirection)}Â°</span>
          </div>
          <div class="meta">
            <span class="badge">ğŸŒ… Lindja: ${sunrise}</span>
            <span class="badge">ğŸŒ‡ PerÃ«ndimi: ${sunset}</span>
          </div>
        </div>
        <div class="temp">${Math.round(c.temperature)}Â°C</div>
      `;
    }

    function renderForecast(wx){
      // Check for daily and daily.time existence
      if (!wx || !wx.daily || !Array.isArray(wx.daily.time)) {
        forecastEl.innerHTML = `<div class="card error">ğŸ˜• TÃ« dhÃ«nat e parashikimit nuk janÃ« tÃ« disponueshme.</div>`;
        if (window.weatherChart && typeof window.weatherChart.destroy === 'function') window.weatherChart.destroy();
        return;
      }
      const d = wx.daily;
      forecastEl.innerHTML = "";
      // Data for chart
      const labels = [];
      const tmaxs = [];
      const tmins = [];
      const humidities = [];
      const pressures = [];
      // Shfaq 5 ditÃ«t e ardhshme (skip indeksi 0 = sot)
      for(let i=1; i<Math.min(d.time.length,6); i++){
        const day = d.time[i];
        const tmax = Math.round(d.temperature_2m_max[i]);
        const tmin = Math.round(d.temperature_2m_min[i]);
        const [txt, emoji] = wmoText(d.weathercode[i]);
        // Precipitation and hours
        const precip = d.precipitation_sum && d.precipitation_sum[i] !== undefined ? d.precipitation_sum[i] + " mm" : "-";
        const precipHours = d.precipitation_hours && d.precipitation_hours[i] !== undefined ? d.precipitation_hours[i] + "h" : "-";
        // Sunrise/sunset
        const sunrise = d.sunrise && d.sunrise[i] ? d.sunrise[i].slice(11,16) : "-";
        const sunset = d.sunset && d.sunset[i] ? d.sunset[i].slice(11,16) : "-";
        // Humidity and pressure (from hourly, take average for the day)
        let avgHumidity = "-", avgPressure = "-";
        let precipStart = "-", strongWindStart = "-";
        if (wx.hourly && wx.hourly.relative_humidity_2m && wx.hourly.pressure_msl && Array.isArray(wx.hourly.time)) {
          // Find all hourly indices for this day
          const dayStr = day.slice(0,10);
          const indices = wx.hourly.time
            .map((t, idx) => t.startsWith(dayStr) ? idx : -1)
            .filter(idx => idx !== -1);
          if (indices.length) {
            const h = indices.map(idx => wx.hourly.relative_humidity_2m[idx]);
            const p = indices.map(idx => wx.hourly.pressure_msl[idx]);
            avgHumidity = Math.round(h.reduce((a,b)=>a+b,0)/h.length) + "%";
            avgPressure = Math.round(p.reduce((a,b)=>a+b,0)/p.length) + " hPa";
            // Find first hour with precipitation > 0
            if (wx.hourly.precipitation) {
              const precipIdx = indices.find(idx => wx.hourly.precipitation[idx] > 0);
              if (typeof precipIdx === 'number' && precipIdx !== -1) {
                precipStart = wx.hourly.time[precipIdx].slice(11,16);
              }
            }
            // Find first hour with windspeed >= 40 km/h
            if (wx.hourly.windspeed_10m) {
              const windIdx = indices.find(idx => wx.hourly.windspeed_10m[idx] >= 40);
              if (typeof windIdx === 'number' && windIdx !== -1) {
                strongWindStart = wx.hourly.time[windIdx].slice(11,16);
              }
            }
          }
        }
        const el = document.createElement("div");
        el.className = "day";
        el.innerHTML = `
          <div>${fmtDate(day)}</div>
          <div class="emoji">${emoji}</div>
          <div class="desc">${txt}</div>
          <div class="t">${tmax}Â° / ${tmin}Â°</div>
          <div class="meta">
            <span class="badge">ğŸ’§ LagÃ«shti: ${avgHumidity}</span>
            <span class="badge">ğŸŒ¡ï¸ Presion: ${avgPressure}</span>
          </div>
          <div class="meta">
            <span class="badge">ğŸŒ§ï¸ Reshje: ${precip}</span>
            <span class="badge">â±ï¸ OrÃ« reshje: ${precipHours}</span>
          </div>
          <div class="meta">
            <span class="badge">ğŸŒ… Lindja: ${sunrise}</span>
            <span class="badge">ğŸŒ‡ PerÃ«ndimi: ${sunset}</span>
          </div>
          <div class="meta">
            <span class="badge">ğŸ•’ Fillon shiu: ${precipStart}</span>
            <span class="badge">ğŸ’¨ ErÃ« tÃ« forta: ${strongWindStart}</span>
          </div>
        `;
        forecastEl.appendChild(el);
        // Chart data
        labels.push(fmtDate(day));
        tmaxs.push(tmax);
        tmins.push(tmin);
        humidities.push(avgHumidity === "-" ? null : parseInt(avgHumidity));
        pressures.push(avgPressure === "-" ? null : parseInt(avgPressure));
      }
      // Draw chart (temperatures, humidity, pressure)
      if (window.weatherChart && typeof window.weatherChart.destroy === 'function') window.weatherChart.destroy();
      const ctx = document.getElementById('weatherChart').getContext('2d');
      window.weatherChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Temp. Max',
              data: tmaxs,
              borderColor: '#0ea5e9',
              backgroundColor: '#0ea5e955',
              tension: 0.3,
              yAxisID: 'y',
            },
            {
              label: 'Temp. Min',
              data: tmins,
              borderColor: '#0369a1',
              backgroundColor: '#0369a155',
              tension: 0.3,
              yAxisID: 'y',
            },
            {
              label: 'LagÃ«shti (%)',
              data: humidities,
              borderColor: '#22d3ee',
              backgroundColor: '#22d3ee55',
              borderDash: [5,5],
              tension: 0.3,
              yAxisID: 'y1',
            },
            {
              label: 'Presion (hPa)',
              data: pressures,
              borderColor: '#fbbf24',
              backgroundColor: '#fbbf2455',
              borderDash: [2,2],
              tension: 0.3,
              yAxisID: 'y2',
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Temperatura (Â°C)' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'LagÃ«shti (%)' }
            },
            y2: {
              type: 'linear',
              position: 'right',
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'Presion (hPa)' },
              offset: true
            }
          }
        }
      });
    }

    function checkExtremeWeather(wx) {
      if (!wx || !wx.current_weather) return;
      const temp = wx.current_weather.temperature;
      const wind = wx.current_weather.windspeed;
      const code = wx.current_weather.weathercode;
      let msg = "";
      if (temp >= 35) msg = "âš ï¸ ParalajmÃ«rim: TemperaturÃ« shumÃ« e lartÃ«!";
      if (temp <= -10) msg = "âš ï¸ ParalajmÃ«rim: TemperaturÃ« shumÃ« e ulÃ«t!";
      if (wind >= 60) msg = "âš ï¸ ParalajmÃ«rim: ErÃ«ra tÃ« forta!";
      if ([95,96,99].includes(code)) msg = "âš ï¸ ParalajmÃ«rim: Stuhi!";
      if (msg) alert(msg);
    }

    async function loadByCoords(lat, lon, labelOverride){
      try{
        setStatus("Duke ngarkuarâ€¦", true);
        const [wx, labelAuto] = await Promise.all([
          getWeather(lat, lon),
          labelOverride ? Promise.resolve(labelOverride) : reverseLookup(lat, lon)
        ]);
        const place = labelOverride || labelAuto || "Lokacioni im";
        renderCurrent(place, wx);
        renderForecast(wx);
        checkExtremeWeather(wx);
        setStatus("U pÃ«rditÃ«sua me sukses.");
        speak(`Moti pÃ«r ${place}: ${Math.round(wx.current_weather.temperature)} gradÃ« celsius.`);
      }catch(err){
        setStatus(err.message || "Ndodhi njÃ« gabim.");
        currentEl.innerHTML = `<div class="card error">ğŸ˜• ${err.message||"Gabim"}</div>`;
      }
    }

    // ============= Ngjarjet UI =============
    btnSearch.addEventListener("click", async ()=>{
      const name = q.value.trim();
      if(!name) { setStatus("Shkruaj emrin e qytetit."); return; }
      try{
        setStatus("Duke kÃ«rkuar qytetinâ€¦", true);
        const {lat,lon,label} = await searchCityByName(name);
        await loadByCoords(lat,lon,label);
      }catch(err){
        setStatus(err.message||"Qyteti nuk u gjet.");
      }
    });

    q.addEventListener("keydown", (e)=>{
      if(e.key==="Enter") btnSearch.click();
    });

    btnGeo.addEventListener("click", ()=>{
      if(!navigator.geolocation) {
        setStatus("Pajisja nuk mbÃ«shtet GPS.");
        return;
      }
      setStatus("Duke marrÃ« lokacioninâ€¦", true);
      navigator.geolocation.getCurrentPosition(
        pos => loadByCoords(pos.coords.latitude, pos.coords.longitude),
        err => setStatus("Sâ€™u mor lokacioni: " + (err.message||"lejet e bllokuara"))
      );
    });

    // Ngarko automatikisht me GPS nÃ« start (opsionale)
    // Komentoje nÃ«se s'e dÃ«shiron:
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos => loadByCoords(pos.coords.latitude, pos.coords.longitude),
        () => setStatus("Lejo GPS-in ose kÃ«rko njÃ« qytet.")
      );
    } else {
      setStatus("Lejo GPS-in ose kÃ«rko njÃ« qytet.");
    }

    // Refresh automatik Ã§do 10 minuta (600000 ms)
setInterval(() => {
  // Rifresko tÃ« dhÃ«nat vetÃ«m nÃ«se ka njÃ« qytet tÃ« zgjedhur
  if(q.value) {
    btnSearch.click();
  }
}, 600000);
  </script>
  <link rel="manifest" href="manifest.json">
  <script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js');
}
</script>
<script>
  // Dark mode automatik nga sistemi
  if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    document.documentElement.classList.add('dark');
  }
</script>
</body>
</html>
